#!/bin/bash

set -x
# CRC_VM_NAME: short VM name to use in crc_libvirt.sh
# VM_PREFIX: full VM name with the random string generated by openshift-installer
CRC_VM_NAME=${CRC_VM_NAME:-crc}

if [[ $# -ne 1 ]]; then
   echo "You need to provide the running cluster directory to copy kubeconfig"
   exit 1
fi

tarballDirectory="crc_libvirt_$(date --iso-8601)"
mkdir $tarballDirectory

random_string=$(sudo virsh list --all | grep -oP "(?<=${CRC_VM_NAME}-).*(?=-master-0)")
if [ -z $random_string ]; then
    echo "Could not find virtual machine created by snc.sh"
    exit 1;
fi
VM_PREFIX=${CRC_VM_NAME}-${random_string}

# Shutdown the instance
sudo virsh shutdown ${VM_PREFIX}-master-0

hostInfo=$(sudo virsh net-dumpxml ${VM_PREFIX} | grep ${VM_PREFIX}-master-0 | sed "s/^[ \t]*//")
masterMac=$(sudo virsh dumpxml ${VM_PREFIX}-master-0 | grep "mac address" | sed "s/^[ \t]*//")

sed "s|ReplaceMeWithCorrectVmName|${CRC_VM_NAME}|g" crc_libvirt.template > $tarballDirectory/crc_libvirt.sh
sed -i "s|ReplaceMeWithCorrectHost|$hostInfo|g" $tarballDirectory/crc_libvirt.sh
sed -i "s|ReplaceMeWithCorrectMac|$masterMac|g" $tarballDirectory/crc_libvirt.sh

chmod +x $tarballDirectory/crc_libvirt.sh

# Create the disk images
sudo cp /var/lib/libvirt/images/${VM_PREFIX}-master-0 $tarballDirectory
sudo cp /var/lib/libvirt/images/${VM_PREFIX}-base $tarballDirectory

sudo chown $USER:$USER -R $tarballDirectory
qemu-img rebase -b ${VM_PREFIX}-base $tarballDirectory/${VM_PREFIX}-master-0
qemu-img commit $tarballDirectory/${VM_PREFIX}-master-0

# TMPDIR must point at a directory with as much free space as the size of the
# image we want to sparsify
TMPDIR=$(pwd)/$tarballDirectory virt-sparsify $tarballDirectory/${VM_PREFIX}-base $tarballDirectory/${CRC_VM_NAME}.qcow2
rm -fr $tarballDirectory/.guestfs-*

rm -fr $tarballDirectory/${VM_PREFIX}-master-0 $tarballDirectory/${VM_PREFIX}-base

# Copy the kubeconfig and kubeadm password file
cp $1/auth/kube* $tarballDirectory/

# Copy the master public key
cp id_rsa_crc $tarballDirectory/master_privatekey
chmod 400 $tarballDirectory/master_privatekey

tar cJSf $tarballDirectory.tar.xz $tarballDirectory
